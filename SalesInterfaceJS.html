<script>
  function loadHome() {
    const content = document.getElementById('content');
    content.innerHTML = `
        <h2>Bienvenue sur la Page d'Accueil</h2>
        <p>Ceci est la page d'accueil de votre logiciel de caisse.</p>
        <p>Utilisez le menu à gauche pour naviguer dans le logiciel.</p>
      `;
  }
  function loadFacture() {
    const content = document.getElementById('content');
    content.innerHTML = `
      <div class="facture">
          <table id="productList">
          <thead>
            <tr>
              <th>Produit</th>
              <th>Prix Unitaire</th>
              <th>Stock</th>
              <th>Quantité</th>
               <th>Remise (%)</th> <!-- Nouvelle colonne pour la remise -->
              <th>Total Ligne</th>
            </tr>
          </thead>
          <tbody>
            <!-- Les lignes de produits seront ajoutées ici -->
          </tbody>
        </table>
        <div id="addProductContainer">
          <button id="addProductButton" onclick="addRow()">Ajouter un produit</button>
        </div>
        <div id="right-menu">
          <h2>Adhérents</h2>
          <select id="adherentsDropdown" onchange="updateEmail()"></select>
          <div id="adherentEmail"></div>
          <div id="cotisationContainer" style="display: none;">
            <label for="cotisationAmount">Montant de cotisation :</label>
            <input type="number" id="cotisationAmount" value="0" min="5" step="1" oninput="calculateTotal()">
        </div>
          <h2>Méthode de Paiement</h2>
          <select id="paymentMethodDropdown" onchange="calculateTotal()">
              <option value="" disabled selected>Sélectionnez un mode de paiement</option>
              <option value="CB">CB</option>
              <option value="Chèque">Chèque</option>
          </select>




          <div id="total">Total Général: 0 €</div>
          <div id="cbFee" style="display: none;">Frais CB: 0 €</div>
          <button id="validateButton" onclick="validate()">Valider</button>
        </div>
      </div>
      `;
    getProducts();
    getAdherents();
    getCotisations(); // Ajoute cette ligne pour charger les cotisations

  }
  function loadReception() {
    const content = document.getElementById('content');
    content.innerHTML = `
      <div class="reception">
          <h1>Réception des Produits</h1>
        <select id="supplierDropdown" onchange="updateProductDropdown(),handleSupplierChange()">
            <option value="">-- Choisissez un fournisseur --</option>
            <!-- Les fournisseurs seront chargés ici -->
        </select>
        <table id="receptionTable">
            <thead>
                <tr>
                    <th>Produit</th>
                    <th>Prix Actuel</th>
                    <th>Mettre à jour le Prix</th>
                    <th>Stock Actuel</th>
                    <th>Mettre à jour le Stock</th>
                    <th>Quantité Réceptionnée</th>
                    <th>Montant Total</th>
                    <th>Delete</th> <!-- Nouvelle colonne pour les actions -->
                </tr>
            </thead>
            <tbody>
            <div id="error-message-reception" style="color: red; display: none;">
                Sélectionnez d'abord un fournisseur.
            </div>
            </tbody>
        </table>
        <div id="totalAmount">Total Réception : 0 €</div>
        <button id="addProductButtonreception" onclick="createNewProduct()">Créer un nouveau produit</button>
        <button id="addProductButton" onclick="addNewLine()">Ajouter une nouvelle ligne</button>
        <button id="validateButton" onclick="validateReception()">Valider la réception</button>
          </div>
    </div>
      `;
    loadSuppliers();
  }
  function loadFournisseur() {
    const content = document.getElementById('content');
    content.innerHTML = `
      <div class="fournisseur">
          <h1>Réception des Produits</h1>
           <button id="addProductButton" onclick="openCreateSupplierPopup()">Ajouter un Fournisseur</button>


        <table id="supplierTable">
        <thead>
            <tr>
                <th>Nom du Fournisseur</th>
                <th>Téléphone</th>
                <th>Email</th>
                <th>Adresse</th>
                <th>Code Postal</th>
                <th>Ville</th>
                <th>Référent</th>
            </tr>
        </thead>
        <tbody id="supplierTableBody">
            <!-- Les fournisseurs seront ajoutés ici via JavaScript -->
        </tbody>
    </table>






       
    </div>
      `;
    getfournisseur();
  }






  function showLoader() {
    const loader = document.createElement('div');
    loader.id = 'loader';
    loader.style.position = 'fixed';
    loader.style.top = '0';
    loader.style.left = '0';
    loader.style.width = '100%';
    loader.style.height = '100%';
    loader.style.backgroundColor = 'rgba(255, 255, 255, 0.8)';
    loader.style.display = 'flex';
    loader.style.alignItems = 'center';
    loader.style.justifyContent = 'center';
    loader.style.zIndex = '1000';
    loader.innerHTML = '<h2>Traitement des données en cours...</h2><div class="spinner"></div>';
    document.body.appendChild(loader);
  }
  function hideLoader() {
    const loader = document.getElementById('loader');
    if (loader) {
      document.body.removeChild(loader);
    }
  }
  function getProducts() {
    google.script.run.withSuccessHandler(function (data) {
      products = data;
      console.log(products);
      addRow();
    }).getProducts();
  }
  function getAdherents() {
    google.script.run.withSuccessHandler(function (data) {
      adherents = data;
      const adherentsDropdown = document.getElementById('adherentsDropdown');
      adherentsDropdown.innerHTML = '<option value="">Sélectionner un adhérent</option>';
      adherents.forEach(adherent => {
        const option = document.createElement('option');
        option.value = adherent.name; // Utilise le nom comme valeur
        option.textContent = adherent.name;
        adherentsDropdown.appendChild(option);
      });
      $(adherentsDropdown).select2({ placeholder: 'Sélectionnez un adhérent', allowClear: true });
    }).getAdherentsWithCotisation();
  }
  function getCotisations() {
    google.script.run.withSuccessHandler(function (data) {
      cotisations = data; // 'data' doit contenir un objet avec les informations de cotisation
    }).getCotisations(); // Assure-toi que cette fonction soit bien définie dans le backend
  }
  function updateEmail() {
    const selectedAdherentName = document.getElementById('adherentsDropdown').value;
    const selectedAdherent = adherents.find(adherent => adherent.name === selectedAdherentName);
    if (selectedAdherent) {
      const emailDiv = document.getElementById('adherentEmail');
      emailDiv.innerText = `Email: ${selectedAdherent.email}`;
      const status = selectedAdherent.cotisation === "ok" ? "à jour" : "non à jour";
      // Vérification de la cotisation dans l'onglet "cotisations"
      const currentMonthYear = new Date().toLocaleString('fr-FR', { month: 'long', year: 'numeric' });
      const cotisationStatus = cotisations[selectedAdherentName]?.[currentMonthYear];
      if (cotisationStatus === "ok") {
        emailDiv.style.color = "black";
        document.getElementById('cotisationContainer').style.display = "none"; // Cacher le champ
      } else {
        emailDiv.style.color = "red"; // Changer le texte en rouge
        emailDiv.innerText += ` | Statut de cotisation: non à jour`;
        document.getElementById('cotisationContainer').style.display = "block"; // Afficher le champ
      }
    } else {
      document.getElementById('adherentEmail').innerText = '';
      document.getElementById('cotisationContainer').style.display = "none"; // Cacher le champ
    }
  }
  function sortProducts(products) {
    // Trier les produits : d'abord par stock, puis par nom
    return products.sort((a, b) => {
      if (a.stock === 0 && b.stock === 0) {
        return 0; // Les deux sont hors stock
      } else if (a.stock === 0) {
        return 1; // 'a' est hors stock, donc on le met en bas
      } else if (b.stock === 0) {
        return -1; // 'b' est hors stock, donc on le met en bas
      }
      return a.name.localeCompare(b.name); // Trier par ordre alphabétique
    });
  }
  function addRow() {
    const productList = document.getElementById('productList').getElementsByTagName('tbody')[0];
    const row = productList.insertRow();
    row.style.opacity = 0;
    const cell1 = row.insertCell(0); // Colonne produit
    const cell2 = row.insertCell(1); // Colonne prix
    const cell3 = row.insertCell(2); // Colonne stock
    const cell4 = row.insertCell(3); // Colonne quantité
    const cell5 = row.insertCell(4); // Colonne discount
    const cell6 = row.insertCell(5); // Colonne total
    const cell7 = row.insertCell(6); // Colonne supprimer
    const cell8 = row.insertCell(7); // Colonne modifier le stock
    // Animation de glissement
    setTimeout(() => {
      row.style.opacity = 1; // Rendre la ligne visible avec une transition
    }, 10); // Attendre un peu avant de démarrer la transition
    const select = document.createElement('select');
    select.classList.add('product-select');
    select.innerHTML = `<option value="">Sélectionner un produit</option>`; // Ligne par défaut
    const sortedProducts = sortProducts(products);
    products.forEach(product => {
      const option = document.createElement('option');
      option.value = product.price;
      option.dataset.price = product.price;
      option.dataset.stock = product.stock;
      option.dataset.name = product.name; // Ajouter le nom du produit pour la mise à jour
      option.textContent = product.name;
      if (product.stock <= 0) {
        option.classList.add('out-of-stock');
      }
      select.appendChild(option);
    });
    cell1.appendChild(select);
    $(select).select2({
      placeholder: 'Recherchez un produit',
      allowClear: true,
      matcher: function (params, data) {
        // Si l'élément est une correspondance exacte, retourner l'élément
        if ($.trim(params.term) === '') {
          return data;
        }


        // Convertir le terme de recherche en tableau de mots
        var searchWords = params.term.toLowerCase().split(/\s+/);


        // Récupérer le texte de l'option (fournisseur)
        var dataText = data.text.toLowerCase();


        // Vérifier si tous les mots de la recherche sont présents dans le texte de l'option
        var match = searchWords.every(function (word) {
          return dataText.includes(word);
        });


        // Si tous les mots sont trouvés, renvoyer l'élément pour qu'il soit affiché
        if (match) {
          return data;
        }


        // Si aucun mot ne correspond, retourner null (ne pas afficher l'élément)
        return null;
      },

      templateResult: function (option) {
        if ($(option.element).hasClass('out-of-stock')) {
          return $('<span style="color:red;">' + option.text + ' (Stock négatif)</span>');
        }
        return option.text;
      }
    });
    select.onchange = function () {
      const selectedOption = select.selectedOptions[0];
      cell2.innerText = `${selectedOption ? selectedOption.dataset.price : 0} €`;
      if (selectedOption) {
        if (selectedOption.dataset.name.toLowerCase().includes("piece")) {
          cell3.innerText = `${selectedOption.dataset.stock} unités`;
        } else if (selectedOption.dataset.name.toLowerCase().includes("kilo")) {
          cell3.innerText = `${selectedOption.dataset.stock} Kg`;
        } else {
          cell3.innerText = `${selectedOption.dataset.stock} unités`; // Par défaut "unités"
        }
      } else {
        cell3.innerText = "0 unités";
      }
      // Vérifiez si le produit contient le mot "piece"
      if (selectedOption && selectedOption.dataset.name.toLowerCase().includes("piece")) {
        quantityInput.setAttribute("step", "1"); // Quantité forcée à un entier
        quantityInput.value = 1; // Définir la quantité à 1 si le produit contient "piece"
      } else {
        quantityInput.setAttribute("step", "0.01"); // Permettre des quantités décimales
        quantityInput.value = 0; // Réinitialiser à 0 si le produit ne contient pas "piece"
      }
      calculateRowTotal(row);
      // Vérification pour ajouter une nouvelle ligne si un produit est sélectionné
      if (selectedOption && selectedOption.value) {
        addRow(); // Ajouter une nouvelle ligne
      }
    };
    const quantityInput = document.createElement('input');
    quantityInput.type = 'number';
    quantityInput.value = 0;
    quantityInput.step = 0.01;
    quantityInput.min = 0; // Vous pouvez définir un minimum pour permettre les quantités de 0 et plus.
    quantityInput.oninput = function () {
      const selectedOption = select.selectedOptions[0];
      // Si le produit contient "piece" et que la quantité est décimale
      if (selectedOption && selectedOption.dataset.name.toLowerCase().includes("piece")) {
        const value = quantityInput.value;
        if (value.includes('.')) {
          alert("La quantité d'un produit contenant 'piece' doit être un entier.");
          quantityInput.value = Math.floor(value); // Réinitialiser à l'entier inférieur
        }
      }
      calculateRowTotal(row);
    };

    cell4.appendChild(quantityInput);








    // Discount input
    const discountInput = document.createElement('input');
    discountInput.type = 'number';
    discountInput.value = 0;
    discountInput.step = 5;
    discountInput.min = 0;
    discountInput.oninput = function () {
      const selectedOption = select.selectedOptions[0];
      if (selectedOption && selectedOption.dataset.name.toLowerCase().includes("piece")) {
        const value = discountInput.value;
        if (value.includes('.')) {
          alert("La remise d'un produit contenant 'piece' doit être un entier.");
          discountInput.value = Math.floor(value); // Round down
        }
      }
      calculateRowTotal(row);
    };
    cell5.appendChild(discountInput);
    // Total de la ligne (initialisé à 0)
    cell6.innerText = '0.00 €';
    // Ajouter l'icône de suppression
    const deleteIcon = document.createElement('span');
    deleteIcon.innerHTML = '❌'; // Utilisez une croix comme symbole ou une image si vous le souhaitez
    deleteIcon.style.cursor = 'pointer';
    deleteIcon.style.marginLeft = '10px';
    deleteIcon.onclick = function () {
      deleteRow(row);
    };
    cell7.appendChild(deleteIcon);
    // Ajouter l'icône de modification du stock
    const editIcon = document.createElement('span');
    editIcon.innerHTML = '✏️'; // Utilisez une icône ou un emoji
    editIcon.style.cursor = 'pointer';
    editIcon.style.marginLeft = '10px';
    editIcon.onclick = function () {
      openStockPopup(select.selectedOptions[0]); // Ouvrir la popup avec le produit sélectionné
    };
    cell8.appendChild(editIcon);
  }
  function deleteRow(row) {
    if (confirm("Êtes-vous sûr de vouloir supprimer cette ligne ?")) {
      const productList = document.getElementById('productList').getElementsByTagName('tbody')[0];
      productList.deleteRow(row.rowIndex - 1);
      calculateTotal();
    }
  }
  function calculateRowTotal(row) {
    const select = row.cells[0].querySelector('select');
    const quantityInput = row.cells[3].querySelector('input');
    const discountInput = row.cells[4].querySelector('input');
    const price = select ? parseFloat(select.value) : 0;
    const quantity = quantityInput ? parseFloat(quantityInput.value) : 0; // Remplacer parseInt par parseFloat
    const discount = discountInput ? parseFloat(discountInput.value) : 0; // Remplacer parseInt par parseFloat
    row.cells[5].innerText = `${(price * quantity - (price * quantity * (discount / 100))).toFixed(2)} €`; // Mettre à jour le total de la ligne
    calculateTotal(); // Recalculer le total général
  }


  function calculateTotal() {
    const rows = document.querySelectorAll('#productList tbody tr');
    let total = 0;
    rows.forEach(row => {
      const totalCell = row.cells[5].innerText;
      total += parseFloat(totalCell.replace(' €', '')) || 0;
    });
    // Ajouter le montant de la cotisation
    const cotisationAmount = parseFloat(document.getElementById('cotisationAmount').value) || 0;
    total += cotisationAmount; // Ajouter le montant de cotisation au total
    document.getElementById('total').innerText = `Total Général: ${total.toFixed(2)} €`;
    // Ajoute le coût CB si nécessaire
    const paymentMethod = document.getElementById('paymentMethodDropdown').value;
    let cbFee = 0;
    if (paymentMethod === "CB") {
      cbFee = total * 0.0055; // 0.55% de frais
      document.getElementById('cbFee').style.display = 'block';
      document.getElementById('cbFee').textContent = `Coût supplémentaire CB: ${cbFee.toFixed(2)} €`;
    } else {
      document.getElementById('cbFee').style.display = 'none';
    }




    // Total avec frais CB si appliqué
    const grandTotal = total + cbFee;
    document.getElementById('total').textContent = `Total Général: ${grandTotal.toFixed(2)} €`;
  }




  function validate() {
    showLoader();

    const adherent = document.getElementById('adherentsDropdown').value;
    const paymentMethod = document.getElementById('paymentMethodDropdown').value;
    const total = parseFloat(document.getElementById('total').innerText.replace('Total Général: ', '').replace(' €', ''));
    const dateTime = new Date().toISOString();
    const cotisationAmount = parseFloat(document.getElementById('cotisationAmount').value) || 0; // Récupérer le montant de cotisation
    const purchases = [];
    const rows = document.querySelectorAll('#productList tbody tr');

    // Renommer la variable pour éviter le conflit
    const invoiceRows = document.querySelectorAll('#productList tbody tr');
    for (const row of invoiceRows) {
      const select = row.cells[0].querySelector('select');
      const quantityInput = row.cells[3].querySelector('input');
      const discountInput = row.cells[4].querySelector('input'); // Champ de remise (assurez-vous que la remise est dans la 5ème colonne)
      const quantity = parseFloat(quantityInput.value) || 0; // Utiliser parseFloat pour permettre les quantités décimales
      const discount = parseFloat(discountInput.value) || 0; // Récupérer la remise
      // Vérifier que le produit est sélectionné avant de vérifier la quantité
      if (select.value && quantity === 0) {
        alert("Veuillez entrer une quantité supérieure à 0 pour tous les produits sélectionnés.");
        hideLoader(); // Cacher le loader si l'alerte est déclenchée
        return; // Sortir de la fonction si une quantité est 0
      }
    }

    if (!adherent || !paymentMethod || total <= 0) {
      alert('Veuillez remplir tous les champs requis.');
      hideLoader(); // Cacher le loader si des champs sont manquants
      return; // Sortir de la fonction si un champ est manquant
    }

    let orderDetails = ''; // Initialiser la variable pour stocker les détails
    rows.forEach(row => {
      const select = row.cells[0].querySelector('select');
      const quantityInput = row.cells[3].querySelector('input');
      const discountInput = row.cells[4].querySelector('input'); // Remise pour chaque ligne
      const productName = select.options[select.selectedIndex].dataset.name; // Récupérer le nom du produit
      const quantity = parseFloat(quantityInput.value) || 0; // Utiliser parseFloat pour permettre les quantités décimales
      const discount = parseFloat(discountInput.value) || 0; // Remise sur le produit
      const price = parseFloat(select.value) || 0; // Utiliser parseFloat pour permettre les prix décimaux
      const lineTotalBeforeDiscount = price * quantity;
      const discountAmount = (lineTotalBeforeDiscount * discount) / 100; // Calcul de la remise en pourcentage
      const totalLine = (lineTotalBeforeDiscount - discountAmount).toFixed(2); // Appliquer la remise et calculer le total de la ligne

      if (productName && quantity > 0) {
        purchases.push({
          productName: productName,
          quantity: quantity,
          price: price, // Ajouter le prix au produit
          discount: discount, // Ajouter la remise dans les achats
          modifiedStock: -quantity // Enregistrer une valeur négative pour diminuer le stock
        });

        // Construire le détail de la commande avec ou sans remise
        if (discount > 0) {
          orderDetails += `${productName} - ${quantity} x ${price.toFixed(2)} €  = ${lineTotalBeforeDiscount.toFixed(2)} € (Remise: ${discount.toFixed(2)}%) = ${totalLine} €\n`;
        } else {
          orderDetails += `${productName} - ${quantity} x ${price.toFixed(2)} €  = ${lineTotalBeforeDiscount.toFixed(2)} € = ${totalLine} €\n`;
        }
      }
    });


    google.script.run.withSuccessHandler(() => {
      console.log('Vente enregistrée et cotisation mise à jour');
      const currentMonthYear = new Date().toLocaleString('fr-FR', { month: 'long', year: 'numeric' });
      const cotisationStatus = cotisations[adherent]?.[currentMonthYear];
      if (cotisationStatus !== "ok") {
        // Met à jour la cotisation seulement si elle n'est pas à jour
        google.script.run.updateCotisation(adherent, currentMonthYear, cotisationAmount);
      }

      // Construction de l'email
      const invoiceEmail = `
            <div style="font-family: Arial, sans-serif; line-height: 1.6;">
                <p>Bonjour,</p>
                <p>Vous trouverez ci-dessous votre dernière facture Coop'az.</p>
                <h2 style="color: #4CAF50;">Facture</h2>
                <p><strong>Adhérent :</strong> ${adherent}</p>
                <p><strong>Date :</strong> ${new Date().toLocaleString('fr-FR')}</p>
                <h3>Détails de la commande :</h3>
                <pre>${orderDetails}</pre> <!-- Utilisez un <pre> pour conserver la mise en forme -->
                ${cotisationAmount > 0 ? `<p><strong>Montant de la cotisation :</strong> ${cotisationAmount.toFixed(2)} €</p>` : ''}
                <h3 style="color: #4CAF50;">Total : ${total.toFixed(2)} €</h3>
                <p><strong>Méthode de Paiement :</strong> ${paymentMethod}</p>
                <p>Merci pour votre commande</p>
                <img src="https://scontent-bru2-1.xx.fbcdn.net/v/t39.30808-6/304383743_535490041712950_2937999491346330678_n.jpg?_nc_cat=101&ccb=1-7&_nc_sid=6ee11a&_nc_ohc=_Sds-7SSXQgQ7kNvgFkPOjQ&_nc_zt=23&_nc_ht=scontent-bru2-1.xx&_nc_gid=ATe01421g4Z-YWApmKNnhFT&oh=00_AYDTFDN4ZkLjhth7pF_kojfSjcSOMq1ATwJ5G1TDsaHO2Q&oe=6728187B" alt="Logo" style="width: 100px; height: auto;">
            </div>
        `;
      const email = adherents.find(a => a.name === adherent).email; // Récupère l'email de l'adhérent
      // Envoie l'email
      google.script.run.sendEmailToAdherent(email, invoiceEmail);
      hideLoader();
      alert('Vente enregistrée !');
      resetForm();
      getProducts();
      loadHome();
    }).saveSale(adherent, paymentMethod, total, dateTime, purchases);
  }




  function resetForm() {
    document.getElementById('adherentsDropdown').value = '';
    document.getElementById('paymentMethodDropdown').value = '';
    const rows = document.querySelectorAll('#productList tbody tr');
    rows.forEach(row => row.remove()); // Supprimer toutes les lignes
  }
  function updateProductPrice(selectedOption, newPrice) {
    // Mettre à jour le prix dans l'option sélectionnée
    selectedOption.dataset.price = newPrice;
    selectedOption.value = newPrice;
    // Mettre à jour l'affichage du prix dans la cellule de prix
    const row = selectedOption.closest('tr');
    row.cells[1].innerText = `${newPrice} €`;
    // Recalculer le total de la ligne et le total général
    calculateRowTotal(row);
  }
  function openStockPopup(selectedOption) {
    if (!selectedOption) {
      alert("Veuillez sélectionner un produit avant de modifier le stock.");
      return;
    }
    const productName = selectedOption.dataset.name;
    const currentStock = selectedOption.dataset.stock;
    const currentPrice = selectedOption.dataset.price;
    // Création de la popup
    const popup = document.createElement('div');
    popup.classList.add('popup');
    popup.style.position = 'fixed';
    popup.style.left = '50%';
    popup.style.top = '50%';
    popup.style.transform = 'translate(-50%, -50%)';
    popup.style.backgroundColor = '#4CAF50';
    popup.style.color = '#fff';
    popup.style.border = '1px solid #ccc';
    popup.style.padding = '20px';
    popup.style.zIndex = '1000';
    popup.style.boxShadow = '2px 2px 10px rgba(0, 0, 0, 0.2)';
    popup.style.borderRadius = '8px'; // Coins arrondis
    // Ajoutez la classe 'show' après l'ajout de la popup
    setTimeout(() => {
      popup.classList.add('show');
    }, 10);
    // Contenu HTML de la popup
    popup.innerHTML = `
          <h2>Modifier le stock et le prix de ${productName}</h2>
          <label for="newStock">Nouveau Stock:</label>
          <input type="number" id="newStock" value="${currentStock}" min="0"><br><br>
          <label for="newPrice">Nouveau Prix:</label>
          <input type="number" id="newPrice" value="${currentPrice}" min="0" step="0.01"><br><br>
          <button id="saveStockButton">Enregistrer</button>
          <button id="cancelButton">Annuler</button>
      `;
    // Ajouter la popup au DOM
    document.body.appendChild(popup);
    // Enregistrer les nouvelles valeurs de stock et de prix
    document.getElementById('saveStockButton').onclick = function () {
      const newStock = parseInt(document.getElementById('newStock').value, 10);
      const newPrice = parseFloat(document.getElementById('newPrice').value);
      // Mise à jour des données dans l'option sélectionnée
      selectedOption.dataset.stock = newStock;
      selectedOption.dataset.price = newPrice;
      // Mise à jour de l'affichage dans la ligne du tableau
      updateStockInRow(selectedOption);
      updateProductPrice(selectedOption, parseFloat(newPrice));
      // Fermer la popup
      document.body.removeChild(popup);
      // Mise à jour dans Google Sheets
      updateSingleProductStockAndPrice(productName, newStock, newPrice);
    };
    // Lorsque vous fermez la popup
    document.getElementById('cancelButton').onclick = function () {
      popup.classList.remove('show'); // Retirez la classe
      setTimeout(() => {
        document.body.removeChild(popup);
      }, 30000); // Retardez la suppression pour laisser le temps à l'animation
    };
    // Annuler et fermer la popup
    document.getElementById('cancelButton').onclick = function () {
      document.body.removeChild(popup);
    };
  }
  function updateStockInRow(selectedOption) {
    const rows = document.querySelectorAll('#productList tbody tr');
    rows.forEach(row => {
      const select = row.cells[0].querySelector('select');
      if (select && select.selectedOptions[0].dataset.name === selectedOption.dataset.name) {
        row.cells[2].innerText = `${selectedOption.dataset.stock} unités`; // Mettre à jour le stock
        row.cells[1].innerText = `${selectedOption.dataset.price} €`; // Mettre à jour le prix
        calculateRowTotal(row); // Recalculer le total de la ligne après modification
      }
    });
  }
  function updateSingleProductStockAndPrice(productName, newStock, newPrice) {
    google.script.run.withSuccessHandler((result) => {
      alert(result); // Confirmation de mise à jour
    }).withFailureHandler((error) => {
      alert("Erreur lors de la mise à jour : " + error.message);
    }).updateProductStockAndPrice(productName, newStock, newPrice);
  }








  ////////////////RECEPTION//////////////////////
  // Fonction pour charger la liste des fournisseurs
  function loadSuppliers() {
    google.script.run.withSuccessHandler(function (suppliers) {
      const dropdown = document.getElementById('supplierDropdown');


      // Trier la liste des fournisseurs par ordre alphabétique
      suppliers.sort((a, b) => a.name.localeCompare(b.name));
      suppliers.forEach(supplier => {
        dropdown.innerHTML += `<option value="${supplier.name}">${supplier.name}</option>`;
      });
    }).receptionGetSuppliers();
  }


  function addNewLine() {
    const newRow = document.createElement('tr');
    newRow.innerHTML = `
        <td>
            <select class="productDropdown" onchange="updatePriceAndStock(this)" disabled>
                <option value="">-- Sélectionnez un produit --</option>
            </select>
        </td>
        <td class="currentPrice"></td>
        <td><input type="number" class="priceUpdate" placeholder="Nouveau Prix" oninput="updateTotalAmount(this.parentElement.parentElement.querySelector('.receivedQuantity'))"></td>
        <td class="currentStock"></td>
        <td><input type="number" class="stockUpdate" placeholder="Nouveau Stock"></td>
        <td><input type="number" class="receivedQuantity" placeholder="Quantité" oninput="updateTotalAmount(this)"></td>
        <td class="totalAmount"></td>
        <td>
            <span class="deleteRow" onclick="deleteReceptionRow(this)" style="color: red; cursor: pointer; font-size: 20px;">&times;</span>
        </td>
    `;
    document.querySelector('#receptionTable tbody').appendChild(newRow);

    // Initialiser Select2 sur le nouvel élément .productDropdown
    $(newRow).find('.productDropdown').select2({
      placeholder: "-- Sélectionnez un produit --",
      allowClear: true,
      minimumResultsForSearch: 0, // Affiche la barre de recherche sans restriction
      width: '100%', // Adapter à la largeur du conteneur
      matcher: function (params, data) {
        if ($.trim(params.term) === '') {
          return data;
        }
        var searchWords = params.term.toLowerCase().split(/\s+/);
        var dataText = data.text.toLowerCase();
        var match = searchWords.every(function (word) {
          return dataText.includes(word);
        });
        return match ? data : null;
      }
    });

    // Récupérer le fournisseur sélectionné et remplir les produits
    const supplier = document.getElementById('supplierDropdown').value;
    if (supplier) {
      google.script.run.withSuccessHandler(function (products) {
        const productDropdown = newRow.querySelector('.productDropdown');

        // Trier les produits par ordre alphabétique
        products.sort((a, b) => a.name.localeCompare(b.name));

        // Ajouter les produits dans le dropdown
        products.forEach(product => {
          productDropdown.innerHTML += `<option value="${product.name}">${product.name}</option>`;
        });

        // Réactiver Select2 et ouvrir la liste après avoir ajouté les produits
        $(newRow).find('.productDropdown').prop('disabled', false).select2('open');

        // Appliquer le focus sur le champ de recherche après l'ouverture du Select2
        setTimeout(function () {
          const searchField = $(newRow).find('.select2-search__field');
          if (searchField.length > 0 && searchField.is(":visible")) {
            searchField.focus(); // Appliquer le focus directement à la zone de recherche
          }
        }, 100); // Attendre un peu pour s'assurer que l'élément est visible
      }).receptionGetProductsBySupplier(supplier);
    }
  }

  function deleteReceptionRow(element) {
    const row = element.closest('tr');
    row.parentNode.removeChild(row); // Supprime la ligne
  }


  function updateProductDropdown() {
    const supplier = document.getElementById('supplierDropdown').value;


    // Appeler la fonction pour récupérer les produits associés au fournisseur
    google.script.run.withSuccessHandler(function (products) {
      const productDropdowns = document.querySelectorAll('.productDropdown');


      // Vérification de l'existence des éléments .productDropdown
      if (productDropdowns.length === 0) {
        console.error("Aucun élément .productDropdown trouvé. Assurez-vous que les éléments existent avant d'appeler Select2.");
        return;
      }






      // Trier les produits par ordre alphabétique
      products.sort((a, b) => a.name.localeCompare(b.name));




      // Mise à jour de chaque dropdown produit
      productDropdowns.forEach(dropdown => {
        // Réinitialiser le contenu du dropdown
        dropdown.innerHTML = '<option value="">-- Sélectionnez un produit --</option>';


        // Ajouter chaque produit dans la liste déroulante
        products.forEach(product => {
          dropdown.innerHTML += `<option value="${product.name}">${product.name}</option>`;
        });


        // Détruire Select2 pour éviter la double initialisation s'il est déjà appliqué
        if ($(dropdown).hasClass("select2-hidden-accessible")) {
          $(dropdown).select2('destroy');
        }


        // Initialiser Select2 sur chaque dropdown de produit
        $(dropdown).select2({
          placeholder: "-- Sélectionnez un produit --",
          minimumResultsForSearch: 0, // Affiche la barre de recherche sans restriction

          allowClear: true,
          width: '100%',// Adapter à la largeur du conteneur
          matcher: function (params, data) {
            // Si l'élément est une correspondance exacte, retourner l'élément
            if ($.trim(params.term) === '') {
              return data;
            }


            // Convertir le terme de recherche en tableau de mots
            var searchWords = params.term.toLowerCase().split(/\s+/);


            // Récupérer le texte de l'option (fournisseur)
            var dataText = data.text.toLowerCase();


            // Vérifier si tous les mots de la recherche sont présents dans le texte de l'option
            var match = searchWords.every(function (word) {
              return dataText.includes(word);
            });


            // Si tous les mots sont trouvés, renvoyer l'élément pour qu'il soit affiché
            if (match) {
              return data;
            }


            // Si aucun mot ne correspond, retourner null (ne pas afficher l'élément)
            return null;
          },
        });
      });


      // Ajouter la première ligne si aucune ligne n'est encore présente
      const receptionTableBody = document.querySelector('#receptionTable tbody');
      if (receptionTableBody.children.length === 0) {
        addNewLine();
      }
    })
      .withFailureHandler(function (error) {
        console.error("Erreur lors de la récupération des produits : ", error);
        alert("Erreur lors de la récupération des produits. Veuillez réessayer.");
      })
      .receptionGetProductsBySupplier(supplier);
  }


  // Fonction pour surveiller l'apparition des éléments .productDropdown
  function waitForProductDropdowns() {
    const observer = new MutationObserver((mutations, obs) => {
      const productDropdowns = document.querySelectorAll('.productDropdown');
      if (productDropdowns.length > 0) {
        // Appeler updateProductDropdown et arrêter l'observateur
        updateProductDropdown();
        obs.disconnect();
      }
    });


    // Observer les changements dans le corps de la page
    observer.observe(document.body, { childList: true, subtree: true });
  }


  // Appeler la fonction d'attente au chargement de la page
  document.addEventListener("DOMContentLoaded", waitForProductDropdowns);


  // Exemple d'appel de la fonction pour ajouter une ligne lors de la sélection d'un fournisseur
  document.getElementById('supplierDropdown').addEventListener('change', function () {
    addNewLine(); // Ajouter une première ligne avec .productDropdown lors de la sélection du fournisseur
  });

  function updatePriceAndStock(selectElement) {
    const row = selectElement.closest('tr');
    const selectedProduct = selectElement.value;
    google.script.run.withSuccessHandler(function (product) {
      if (product) {
        row.querySelector('.currentPrice').textContent = product.price;
        row.querySelector('.currentStock').textContent = product.stock;
        updateTotalAmount(row.querySelector('.receivedQuantity')); // Met à jour le montant total avec la quantité saisie
      } else {
        row.querySelector('.currentPrice').textContent = '';
        row.querySelector('.currentStock').textContent = '';
        row.querySelector('.totalAmount').textContent = ''; // Réinitialiser le montant total
      }
    }).withFailureHandler(function (error) {
      alert("Erreur lors de la récupération des détails du produit : " + error.message);
    }).receptionGetProductDetails(selectedProduct);
  }

  function updateTotalAmount(quantityInput) {
    const row = quantityInput.closest('tr');
    const productSelect = row.querySelector('.productDropdown');
    const selectedProduct = productSelect.options[productSelect.selectedIndex].text;
    // Vérifiez si le produit contient "piece" pour définir l'autorisation des décimales
    const allowsDecimal = !selectedProduct.toLowerCase().includes('piece');
    // Récupérez la valeur de la quantité, en utilisant parseFloat si les décimales sont autorisées, sinon parseInt
    const quantity = allowsDecimal ? parseFloat(quantityInput.value) || 0 : parseInt(quantityInput.value) || 0;
    const priceUpdateInput = parseFloat(row.querySelector('.priceUpdate').value) || 0;
    const currentPrice = parseFloat(row.querySelector('.currentPrice').textContent) || 0;
    const price = priceUpdateInput || currentPrice;
    const total = price * quantity;
    row.querySelector('.totalAmount').textContent = total.toFixed(2) + ' €';
    updateGrandTotal();
  }
  function updateGrandTotal() {
    const rows = document.querySelectorAll('#receptionTable tbody tr');
    let grandTotal = 0;
    rows.forEach(row => {
      const total = row.querySelector('.totalAmount').textContent;
      grandTotal += parseFloat(total) || 0;
    });
    document.getElementById('totalAmount').textContent = 'Total Réception : ' + grandTotal.toFixed(2) + ' €';
  }
  function validateReception() {
    const rows = document.querySelectorAll('#receptionTable tbody tr');
    const receptions = [];


    rows.forEach(row => {
      const productSelect = row.querySelector('.productDropdown');
      const productName = productSelect.value;


      if (productName) {
        const allowsDecimal = !productName.toLowerCase().includes('piece');
        const priceUpdateInput = row.querySelector('.priceUpdate').value;
        const stockUpdateInput = row.querySelector('.stockUpdate').value;
        const receivedQuantityInput = row.querySelector('.receivedQuantity').value;


        const currentStock = parseFloat(row.querySelector('.currentStock').textContent) || 0;


        let stockUpdate = currentStock;  // Par défaut, on garde le stock actuel


        // Si un nouveau stock est renseigné, il remplace le stock actuel
        if (stockUpdateInput) {
          stockUpdate = parseFloat(stockUpdateInput);
        }


        // Si une quantité réceptionnée est renseignée, on l'ajoute au stock
        if (receivedQuantityInput) {
          let receivedQuantity = allowsDecimal ? parseFloat(receivedQuantityInput) || 0 : parseInt(receivedQuantityInput, 10);
          stockUpdate += receivedQuantity;
        }


        const currentPrice = parseFloat(row.querySelector('.currentPrice').textContent) || 0;
        const priceUpdate = priceUpdateInput ? parseFloat(priceUpdateInput).toFixed(2) : currentPrice.toFixed(2);


        // On envoie les données de cette ligne
        receptions.push({
          productName,
          priceUpdate: priceUpdate,
          stockUpdate: stockUpdate.toFixed(2),
          receivedQuantity: receivedQuantityInput ? receivedQuantityInput.toFixed(2) : "0.00"
        });
      }
    });


    // Appel au script Google Apps pour enregistrer la réception
    google.script.run.receptionValidateReception(receptions);
    alert('Réception enregistrée !');
    loadHome();
  }








  let selectedSupplier = "";  // Variable pour stocker le fournisseur sélectionné




  // Fonction appelée à chaque changement dans la liste déroulante des fournisseurs
  function handleSupplierChange() {
    const supplierDropdown = document.getElementById('supplierDropdown');
    const errorMessage = document.getElementById('error-message-reception');
    const createProductButton = document.getElementById('createProductButton');




    selectedSupplier = supplierDropdown.value;  // Stocker le fournisseur sélectionné




    if (selectedSupplier === "") {
      // Aucune sélection de fournisseur, afficher le message d'erreur
      errorMessage.style.display = 'block';
      createProductButton.disabled = true;  // Désactiver le bouton de création de produit
    } else {
      // Fournisseur sélectionné, masquer le message d'erreur et activer le bouton
      errorMessage.style.display = 'none';
      createProductButton.disabled = false;  // Activer le bouton de création de produit
    }
  }




  // Fonction pour ouvrir le popup de création de produit
  function createNewProduct() {
    if (selectedSupplier === "") {
      alert("Sélectionnez d'abord un fournisseur");
      return;
    }

    // Ouvrir la popup pour créer un nouveau produit
    openCreateProductPopup();
  }




  // Fonction pour ouvrir la popup de création de produit
  function openCreateProductPopup() {
    const supplierSelect = document.getElementById("supplierDropdown");





    const popupHtml = `
      <div class="popup-overlay">
        <div class="popup-content">
          <h2>Créer un nouveau produit</h2>
          <form id="createProductForm">
            <label>Nom du produit</label>
            <input type="text" id="productName" required><br><br>
           
            <label>Code-barres</label>
            <input type="text" id="productBarcode"><br><br>




            <label>Unité de mesure</label>
            <select id="productUnit" required>
              <option value="">Sélectionnez une unité</option>
              <option value="Kilo">Kilo</option>
              <option value="Piece">Piece</option>
              <option value="Litre">Litre</option>
            </select><br><br>




            <label>Prix</label>
            <input type="number" id="productPrice" step="0.01" required><br><br>




            <label>Quantité reçue</label>
            <input type="number" id="productQuantity" step="0.01" required><br><br>




            <button type="button" onclick="saveNewProduct()">Valider</button>
            <button type="button" onclick="closePopup()">Annuler</button>
          </form>
        </div>
      </div>
    `;
    document.body.insertAdjacentHTML('beforeend', popupHtml);
  }




  // Fonction pour fermer la popup
  function closePopup() {
    const overlay = document.querySelector('.popup-overlay');
    if (overlay) overlay.remove();
  }




  // Fonction pour enregistrer un nouveau produit
  function saveNewProduct() {
    const productData = {
      name: document.getElementById('productName').value,
      barcode: document.getElementById('productBarcode').value,
      unit: document.getElementById('productUnit').value,
      price: parseFloat(document.getElementById('productPrice').value),
      quantity: parseFloat(document.getElementById('productQuantity').value),
      supplier: selectedSupplier  // Ajouter le fournisseur sélectionné
    };




    // Vérifier que tous les champs obligatoires sont remplis
    if (!productData.name || !productData.unit || !productData.price || !productData.quantity) {
      alert("Veuillez remplir tous les champs obligatoires.");
      return;
    }




    // Appel à Google Apps Script pour enregistrer le produit avec le fournisseur
    google.script.run.withSuccessHandler(response => {
      alert(response);
      closePopup();
      loadHome();
    }).receptionCreateProduct(productData);  // Passer toutes les données, y compris le fournisseur
  }


  ///////FOURNISEEUR/////////////////






  function getfournisseur() {// Affiche le loader pendant le chargement
    showLoader(true);  // Appel à votre fonction showLoader pour afficher le loader


    // Appel à Google Apps Script pour récupérer les fournisseurs
    google.script.run.withSuccessHandler(function (suppliers) {
      // Une fois les données récupérées, affiche les fournisseurs
      displaySuppliers(suppliers);
    }).getSuppliers();  // Appel de la fonction `getSuppliers`
  }


  // Charge les fournisseurs lorsque la page est prête
  document.addEventListener("DOMContentLoaded", function () {
    loadSuppliers();  // Charge les fournisseurs au chargement de la page
  });


  // Fonction pour afficher les fournisseurs dans le tableau
  function displaySuppliers(suppliers) {
    const supplierTableBody = document.getElementById('supplierTableBody');
    supplierTableBody.innerHTML = ''; // Réinitialiser le tableau avant de remplir


    suppliers.forEach(supplier => {
      const row = document.createElement('tr');


      const supplierNameCell = document.createElement('td');
      supplierNameCell.textContent = supplier.name;
      row.appendChild(supplierNameCell);


      const emailCell = document.createElement('td');
      emailCell.textContent = supplier.email;
      row.appendChild(emailCell);


      const phoneCell = document.createElement('td');
      phoneCell.textContent = supplier.phone;
      row.appendChild(phoneCell);


      const addressCell = document.createElement('td');
      addressCell.textContent = supplier.address;
      row.appendChild(addressCell);
      const codePostalCell = document.createElement('td');
      codePostalCell.textContent = supplier.codePostal;
      row.appendChild(codePostalCell);
      const villeCell = document.createElement('td');
      villeCell.textContent = supplier.ville;
      row.appendChild(villeCell);


      const referentCell = document.createElement('td');
      referentCell.textContent = supplier.referent;
      row.appendChild(referentCell);


      supplierTableBody.appendChild(row);
    });
    // Masque le loader après avoir affiché les fournisseurs
    hideLoader();
  }


  // Fonction pour charger les référents dans le menu déroulant
  function loadReferents() {
    google.script.run.withSuccessHandler(function (referents) {
      const referentSelect = document.getElementById('supplierReferent');
      referents.forEach(function (referent) {
        const option = document.createElement('option');
        option.value = referent[0];  // Utiliser la valeur du référent
        option.textContent = referent[0];  // Afficher le nom du référent
        referentSelect.appendChild(option);
      });
    }).getReferents();
  }




  // Fonction pour ouvrir la popup de création de fournisseur
  function openCreateSupplierPopup() {
    const popupHtml = `
      <div class="popup-overlay">
        <div class="popup-content">
          <h2>Créer un nouveau fournisseur</h2>
          <form id="createSupplierForm">
            <label>Nom du fournisseur</label>
            <input type="text" id="supplierName" required><br><br>
           
            <label>Téléphone</label>
            <input type="text" id="supplierPhone" required><br><br>
           
            <label>Email</label>
            <input type="email" id="supplierEmail" required><br><br>
           
            <label>Adresse</label>
            <input type="text" id="supplierAddress" required><br><br>
           
            <label>Référent</label>
            <select id="supplierReferent" required>
                <option value="">Sélectionnez un référent</option>
                <!-- Les options des référents seront ajoutées ici -->
            </select><br><br>


            <button type="button" onclick="saveNewSupplier()">Valider</button>
            <button type="button" onclick="closePopup()">Annuler</button>
          </form>
        </div>
      </div>
    `;
    document.body.insertAdjacentHTML('beforeend', popupHtml);
    loadReferents();  // Charger les référents après ouverture de la popup
  }


  // Fonction pour fermer la popup
  function closePopup() {
    const overlay = document.querySelector('.popup-overlay');
    if (overlay) overlay.remove();
  }


  // Fonction pour enregistrer un nouveau fournisseur
  function saveNewSupplier() {
    const supplierData = {
      name: document.getElementById('supplierName').value,
      email: document.getElementById('supplierEmail').value,
      phone: document.getElementById('supplierPhone').value,
      address: document.getElementById('supplierAddress').value,
      codePostal: document.getElementById('suppliercodePostal').value,
      ville: document.getElementById('supplierville').value,
      referent: document.getElementById('supplierReferent').value
    };


    // Vérifier que tous les champs obligatoires sont remplis
    if (!supplierData.name || !supplierData.email) {
      alert("Veuillez remplir tous les champs obligatoires.");
      return;
    }
    // Afficher le loader pendant l'enregistrement
    showLoader(true);
    // Appel à Google Apps Script pour enregistrer le fournisseur
    google.script.run.withSuccessHandler(response => {
      alert(response);
      closePopup();
      getfournisseur(); // Recharger la liste des fournisseurs après ajout
      hideLoader();  // Masquer le loader après l'enregistrement


    }).createSupplier(supplierData);  // Passer toutes les données du fournisseur
  }








  // Charger les produits et les adhérents lors du chargement de la page
  $(document).ready(function () {

  });
</script>